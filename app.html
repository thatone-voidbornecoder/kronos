<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="https://i.imgur.com/j7zxM6Z.png">
<title>Kronos</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --gold: #f5a623; --green: #00ff88; --red: #ff4444;
  --break-col: #b8ff3c; --break-glow: rgba(184,255,60,0.4);
  --study-col: #00d4ff; --study-glow: rgba(0,212,255,0.35);
  --bg: #080810; --panel: #0d0d1a; --border: #1a1a30; --dim: #2a2a48; --dim-text: #444466;
}
body { background:var(--bg); color:#fff; font-family:'Share Tech Mono',monospace; min-height:100vh; display:flex; flex-direction:column; overflow-x:hidden; }
body::before { content:''; position:fixed; inset:0; background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.06) 2px,rgba(0,0,0,0.06) 4px); pointer-events:none; z-index:9999; }

/* ‚îÄ‚îÄ LOADING SCREEN ‚îÄ‚îÄ */
#loading-screen { position:fixed; inset:0; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:1rem; z-index:9998; }
#loading-screen .logo { font-family:'Orbitron',sans-serif; font-weight:900; font-size:3rem; color:var(--gold); text-shadow:0 0 40px rgba(245,166,35,0.6); letter-spacing:0.15em; }
#loading-screen .load-sub { font-size:0.65rem; letter-spacing:0.3em; color:var(--dim-text); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
#loading-screen .load-sub { animation:pulse 1.5s infinite; }

/* ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ */
#setup-screen { flex:1; display:none; flex-direction:column; align-items:center; padding:2rem 1.5rem 3rem; gap:1.4rem; }
#setup-screen h1 { font-family:'Orbitron',sans-serif; font-size:clamp(1.3rem,3.5vw,2rem); font-weight:900; color:var(--gold); text-shadow:0 0 28px rgba(245,166,35,0.55); letter-spacing:0.12em; margin-top:0.5rem; }
.setup-user-bar { display:flex; align-items:center; justify-content:space-between; width:100%; max-width:1060px; font-size:0.7rem; color:var(--dim-text); }
.setup-user-bar span { letter-spacing:0.1em; }
.setup-user-bar button { font-family:'Orbitron',sans-serif; font-size:0.6rem; letter-spacing:0.1em; padding:0.3rem 0.7rem; border:1px solid var(--dim); background:transparent; color:var(--dim-text); cursor:pointer; transition:all 0.2s; }
.setup-user-bar button:hover { border-color:var(--red); color:var(--red); box-shadow:none; }

.day-tabs { display:flex; gap:0.3rem; flex-wrap:wrap; justify-content:center; }
.day-tab { font-family:'Orbitron',sans-serif; font-size:0.68rem; letter-spacing:0.12em; padding:0.45rem 1.1rem; border:2px solid var(--dim); background:transparent; color:var(--dim-text); cursor:pointer; transition:all 0.2s; }
.day-tab:hover { border-color:var(--gold); color:var(--gold); box-shadow:none; }
.day-tab.active { border-color:var(--gold); color:#000; background:var(--gold); box-shadow:0 0 14px rgba(245,166,35,0.45); }

.copy-row { display:flex; align-items:center; gap:0.6rem; font-size:0.72rem; color:var(--dim-text); flex-wrap:wrap; justify-content:center; }
.copy-row select { background:var(--panel); border:1px solid var(--dim); color:#aaa; font-family:'Share Tech Mono',monospace; font-size:0.72rem; padding:0.28rem 0.5rem; outline:none; cursor:pointer; }

.setup-table-wrap { width:100%; max-width:1060px; overflow-x:auto; }
table { width:100%; border-collapse:collapse; font-size:0.88rem; }
thead th { font-family:'Orbitron',sans-serif; font-size:0.6rem; letter-spacing:0.15em; color:var(--gold); padding:0.7rem 0.5rem; border-bottom:2px solid var(--gold); text-align:left; white-space:nowrap; }
tbody tr { border-bottom:1px solid var(--border); transition:background 0.2s; }
tbody tr:hover { background:rgba(245,166,35,0.03); }
tbody tr.is-break { background:rgba(184,255,60,0.025); }
tbody tr.is-study { background:rgba(0,212,255,0.02); }
tbody td { padding:0.35rem 0.3rem; vertical-align:middle; }
tbody td input[type="text"],tbody td input[type="number"],tbody td input[type="time"] { background:transparent; border:none; border-bottom:1px solid var(--dim); color:#bbb; font-family:'Share Tech Mono',monospace; font-size:0.84rem; padding:0.28rem 0.2rem; outline:none; transition:border-color 0.2s,color 0.2s; }
tbody td input[type="number"] { width:50px; }
tbody td input[type="time"] { width:100px; }
tbody td input[type="text"] { width:100%; min-width:160px; }
tbody td input:focus { border-bottom-color:var(--gold); color:#fff; }
tr.is-break td input { color:var(--break-col) !important; border-bottom-color:rgba(184,255,60,0.3) !important; }
tr.is-study td input { color:var(--study-col) !important; border-bottom-color:rgba(0,212,255,0.3) !important; }
.type-select { background:transparent; border:1px solid var(--dim); color:#aaa; font-family:'Share Tech Mono',monospace; font-size:0.75rem; padding:0.22rem 0.3rem; outline:none; cursor:pointer; }
tr.is-break .type-select { color:var(--break-col); border-color:rgba(184,255,60,0.35); }
tr.is-study .type-select { color:var(--study-col); border-color:rgba(0,212,255,0.35); }

.btn-row { display:flex; gap:0.8rem; flex-wrap:wrap; justify-content:center; }
.save-indicator { font-size:0.65rem; letter-spacing:0.12em; color:var(--green); opacity:0; transition:opacity 0.4s; }
.save-indicator.show { opacity:1; }

button { font-family:'Orbitron',sans-serif; font-size:0.72rem; letter-spacing:0.1em; padding:0.55rem 1.3rem; border:2px solid var(--gold); background:transparent; color:var(--gold); cursor:pointer; transition:background 0.2s,color 0.2s,box-shadow 0.2s; }
button:hover { background:var(--gold); color:#000; box-shadow:0 0 18px rgba(245,166,35,0.45); }
button.break-btn { border-color:var(--break-col); color:var(--break-col); }
button.break-btn:hover { background:var(--break-col); color:#000; box-shadow:0 0 18px var(--break-glow); }
button.study-btn { border-color:var(--study-col); color:var(--study-col); }
button.study-btn:hover { background:var(--study-col); color:#000; box-shadow:0 0 18px var(--study-glow); }
button.danger { border-color:var(--red); color:var(--red); font-size:0.68rem; padding:0.28rem 0.65rem; border-width:1px; }
button.danger:hover { background:var(--red); color:#fff; box-shadow:none; }
button.go { font-size:0.95rem; padding:0.8rem 2.8rem; }

/* ‚îÄ‚îÄ DISPLAY SCREEN ‚îÄ‚îÄ */
#display-screen { display:none; flex:1; flex-direction:column; min-height:100vh; position:relative; }
.top-bar { display:flex; align-items:center; justify-content:space-between; padding:0.45rem 1.4rem; background:var(--panel); border-bottom:1px solid var(--border); gap:0.8rem; flex-wrap:wrap; z-index:10; }
.top-bar-left { display:flex; align-items:center; gap:0.9rem; flex-wrap:wrap; }
.top-bar .clock { font-family:'Orbitron',sans-serif; font-size:0.95rem; color:var(--gold); letter-spacing:0.1em; white-space:nowrap; }
.top-bar-right { display:flex; align-items:center; gap:0.6rem; }
.user-chip { font-size:0.6rem; letter-spacing:0.1em; color:var(--dim-text); white-space:nowrap; }
.display-day-tabs { display:flex; gap:0.25rem; }
.display-day-tab { font-family:'Orbitron',sans-serif; font-size:0.58rem; letter-spacing:0.1em; padding:0.28rem 0.65rem; border:1px solid var(--dim); background:transparent; color:var(--dim-text); cursor:pointer; transition:all 0.15s; position:relative; }
.display-day-tab:hover { border-color:var(--gold); color:var(--gold); box-shadow:none; }
.display-day-tab.active { border-color:var(--gold); background:var(--gold); color:#000; }
.display-day-tab.day-done { border-color:rgba(0,255,136,0.4); color:rgba(0,255,136,0.6); }
.display-day-tab.day-upcoming { opacity:0.45; }
.day-pip { position:absolute; top:2px; right:2px; width:4px; height:4px; border-radius:50%; background:var(--green); }
.streak-badge { font-family:'Orbitron',sans-serif; font-size:0.58rem; letter-spacing:0.12em; color:var(--gold); white-space:nowrap; }
.edit-btn { font-size:0.6rem !important; padding:0.3rem 0.85rem !important; }

.school-day-bar-strip { background:var(--panel); border-bottom:1px solid var(--border); padding:0.4rem 1.5rem 0.52rem; display:flex; flex-direction:column; gap:0.28rem; }
.school-day-bar-header { display:flex; justify-content:space-between; align-items:center; }
.school-day-label { font-family:'Orbitron',sans-serif; font-size:0.58rem; letter-spacing:0.2em; color:var(--dim-text); }
.school-day-pct { font-family:'Orbitron',sans-serif; font-size:0.58rem; letter-spacing:0.12em; color:var(--dim-text); }
.school-day-track { width:100%; height:4px; background:var(--dim); border-radius:2px; overflow:hidden; }
.school-day-fill { height:100%; background:linear-gradient(90deg,#333355,#666688); border-radius:2px; transition:width 1s linear; }
.school-day-fill.active-class { background:linear-gradient(90deg,var(--gold),#ffcc55); box-shadow:0 0 6px rgba(245,166,35,0.6); }
.school-day-fill.on-break { background:linear-gradient(90deg,var(--break-col),#deff99); box-shadow:0 0 6px var(--break-glow); }
.school-day-fill.on-study { background:linear-gradient(90deg,var(--study-col),#88eeff); box-shadow:0 0 6px var(--study-glow); }
.school-day-fill.day-complete { background:linear-gradient(90deg,var(--green),#88ffcc); box-shadow:0 0 6px rgba(0,255,136,0.5); }

.main-display { flex:1; display:grid; grid-template-columns:1fr 1px 1fr; min-height:0; position:relative; }
.divider { background:linear-gradient(to bottom,transparent,rgba(245,166,35,0.35),transparent); }
.divider.break-div { background:linear-gradient(to bottom,transparent,var(--break-glow),transparent); }
.divider.study-div { background:linear-gradient(to bottom,transparent,var(--study-glow),transparent); }

.left-panel { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:2.5rem 2rem; gap:1.3rem; transition:background 0.6s; position:relative; overflow:hidden; }
.left-panel.break-bg { background:rgba(184,255,60,0.022); }
.left-panel.study-bg { background:rgba(0,212,255,0.022); }
.period-label { font-family:'Orbitron',sans-serif; font-size:0.65rem; letter-spacing:0.25em; color:var(--dim-text); }
.percent-display { font-family:'Orbitron',sans-serif; font-size:clamp(4.5rem,13vw,9rem); font-weight:900; color:var(--gold); text-shadow:0 0 50px rgba(245,166,35,0.65),0 0 100px rgba(245,166,35,0.25); line-height:1; letter-spacing:-0.02em; transition:color 0.5s,text-shadow 0.5s; }
.percent-symbol { font-size:0.38em; vertical-align:super; opacity:0.7; }
.percent-display.near-end { color:var(--red); text-shadow:0 0 50px rgba(255,68,68,0.7),0 0 100px rgba(255,68,68,0.3); }
.percent-display.break-display { color:var(--break-col); text-shadow:0 0 50px var(--break-glow),0 0 100px rgba(184,255,60,0.2); }
.percent-display.study-display { color:var(--study-col); text-shadow:0 0 50px var(--study-glow),0 0 100px rgba(0,212,255,0.15); }
.percent-display.free-display { color:var(--green); text-shadow:0 0 50px rgba(0,255,136,0.5); font-size:clamp(2.5rem,7vw,5rem); letter-spacing:0.05em; }
@keyframes flicker { 0%,100%{opacity:1} 91%{opacity:1} 92%{opacity:.88} 93%{opacity:1} 96%{opacity:.93} 97%{opacity:1} }
.percent-display { animation:flicker 9s infinite; }
@keyframes studyPulse { 0%,100%{opacity:0.12;transform:scale(1)} 50%{opacity:0.28;transform:scale(1.06)} }
.study-pulse-ring { position:absolute; width:280px; height:280px; border-radius:50%; border:1px solid var(--study-col); opacity:0; pointer-events:none; animation:studyPulse 3s ease-in-out infinite; }
.left-panel.study-bg .study-pulse-ring { opacity:0.18; }
.progress-bar-track { width:78%; max-width:320px; height:5px; background:var(--border); border-radius:3px; overflow:hidden; }
.progress-bar-fill { height:100%; background:linear-gradient(90deg,var(--gold),#ffcc55); border-radius:3px; transition:width 1s linear; box-shadow:0 0 10px rgba(245,166,35,0.7); }
.progress-bar-fill.near-end { background:linear-gradient(90deg,var(--red),#ff9999); box-shadow:0 0 10px rgba(255,68,68,0.7); }
.progress-bar-fill.break-fill { background:linear-gradient(90deg,var(--break-col),#deff99); box-shadow:0 0 10px var(--break-glow); }
.progress-bar-fill.study-fill { background:linear-gradient(90deg,var(--study-col),#88eeff); box-shadow:0 0 10px var(--study-glow); }
.progress-bar-fill.free-fill { background:linear-gradient(90deg,var(--green),#88ffcc); box-shadow:0 0 10px rgba(0,255,136,0.6); }
.time-label { font-size:0.6rem; letter-spacing:0.2em; color:var(--dim-text); }
.time-remaining { font-family:'Orbitron',sans-serif; font-size:clamp(1.8rem,5.5vw,3.5rem); font-weight:700; color:var(--green); text-shadow:0 0 25px rgba(0,255,136,0.55); letter-spacing:0.05em; }
.time-remaining.break-timer { color:var(--break-col); text-shadow:0 0 25px var(--break-glow); }
.time-remaining.study-timer { color:var(--study-col); text-shadow:0 0 25px var(--study-glow); }

.right-panel { display:flex; flex-direction:column; align-items:flex-start; justify-content:center; padding:2.5rem; gap:2rem; }
.section-tag { font-family:'Orbitron',sans-serif; font-size:0.6rem; letter-spacing:0.25em; color:var(--dim-text); margin-bottom:0.25rem; }
.period-emoji { font-size:2rem; line-height:1; margin-bottom:-0.2rem; }
.current-class-name { font-family:'Orbitron',sans-serif; font-size:clamp(1.4rem,3.8vw,2.6rem); font-weight:900; color:var(--gold); text-shadow:0 0 25px rgba(245,166,35,0.45); line-height:1.2; letter-spacing:0.04em; text-transform:uppercase; }
.current-class-name.break-name { color:var(--break-col); text-shadow:0 0 25px var(--break-glow); }
.current-class-name.study-name { color:var(--study-col); text-shadow:0 0 25px var(--study-glow); }
.current-class-time { font-size:0.8rem; color:#555577; letter-spacing:0.04em; margin-top:0.3rem; }
.next-class-name { font-family:'Orbitron',sans-serif; font-size:clamp(0.9rem,2.3vw,1.5rem); font-weight:700; color:#666688; letter-spacing:0.04em; text-transform:uppercase; line-height:1.2; }
.next-class-time { font-size:0.75rem; color:#3a3a58; margin-top:0.2rem; }
.quote-box { margin-top:0.5rem; border-left:2px solid var(--dim); padding-left:0.8rem; max-width:340px; }
.quote-text { font-size:0.75rem; color:#555577; line-height:1.5; font-style:italic; }
.quote-author { font-size:0.62rem; color:var(--dim-text); margin-top:0.3rem; letter-spacing:0.08em; }

.day-status-overlay { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:1rem; z-index:20; pointer-events:none; opacity:0; transition:opacity 0.4s; }
.day-status-overlay.visible { opacity:1; pointer-events:auto; }
.day-status-overlay.done-overlay { background:rgba(8,8,16,0.88); }
.day-status-overlay.upcoming-overlay { background:rgba(8,8,16,0.82); }
.status-big { font-family:'Orbitron',sans-serif; font-weight:900; letter-spacing:0.08em; text-align:center; line-height:1.1; }
.done-overlay .status-big { font-size:clamp(3rem,10vw,7rem); color:var(--green); }
.upcoming-overlay .status-big { font-size:clamp(2rem,7vw,5rem); color:var(--dim-text); }
.status-sub { font-family:'Share Tech Mono',monospace; font-size:clamp(0.75rem,2vw,1rem); letter-spacing:0.2em; text-align:center; }
.done-overlay .status-sub { color:rgba(0,255,136,0.5); }
.upcoming-overlay .status-sub { color:var(--dim-text); }
.streak-display { font-family:'Orbitron',sans-serif; font-size:0.85rem; color:var(--gold); letter-spacing:0.15em; margin-top:0.5rem; }
@keyframes doneGlow { 0%,100%{text-shadow:0 0 60px rgba(0,255,136,0.6),0 0 120px rgba(0,255,136,0.2)} 50%{text-shadow:0 0 90px rgba(0,255,136,0.9),0 0 180px rgba(0,255,136,0.4)} }
.done-overlay .status-big { animation:doneGlow 3s ease-in-out infinite; }

.history-strip { background:var(--panel); border-top:1px solid var(--border); padding:0.35rem 1.5rem; display:flex; align-items:center; gap:1rem; overflow:hidden; min-height:32px; }
.history-label { font-family:'Orbitron',sans-serif; font-size:0.55rem; letter-spacing:0.2em; color:var(--dim-text); white-space:nowrap; flex-shrink:0; }
.history-items { display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap; }
.history-pill { font-size:0.65rem; padding:0.15rem 0.55rem; border:1px solid var(--dim); color:var(--dim-text); border-radius:20px; white-space:nowrap; }
.history-pill.class-pill { border-color:rgba(245,166,35,0.3); color:rgba(245,166,35,0.6); }
.history-pill.break-pill { border-color:rgba(184,255,60,0.3); color:rgba(184,255,60,0.6); }
.history-pill.study-pill { border-color:rgba(0,212,255,0.3); color:rgba(0,212,255,0.6); }

/* Drawers */
.drawer-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:998; opacity:0; pointer-events:none; transition:opacity 0.3s; }
.drawer-backdrop.show { opacity:1; pointer-events:auto; }
.side-drawer { position:fixed; top:0; right:-380px; width:360px; height:100vh; background:var(--panel); border-left:1px solid var(--border); display:flex; flex-direction:column; z-index:999; transition:right 0.35s cubic-bezier(0.4,0,0.2,1); box-shadow:-4px 0 30px rgba(0,0,0,0.5); }
.side-drawer.open { right:0; }
.drawer-header { display:flex; align-items:center; justify-content:space-between; padding:1.2rem 1.3rem 0.9rem; border-bottom:1px solid var(--border); }
.drawer-header h2 { font-family:'Orbitron',sans-serif; font-size:0.82rem; letter-spacing:0.15em; color:var(--gold); }
.drawer-close { background:transparent; border:1px solid var(--dim); color:var(--dim-text); padding:0.25rem 0.55rem; font-size:0.7rem; cursor:pointer; transition:all 0.2s; }
.drawer-close:hover { border-color:var(--red); color:var(--red); box-shadow:none; background:transparent; }

.fab-group { position:fixed; bottom:1.8rem; right:1.8rem; display:flex; flex-direction:column; gap:0.6rem; align-items:flex-end; z-index:1000; }
.fab { width:46px; height:46px; border-radius:50%; border:2px solid var(--gold); background:var(--panel); color:var(--gold); font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 0 20px rgba(245,166,35,0.25); transition:all 0.2s; position:relative; }
.fab:hover { background:var(--gold); color:#000; box-shadow:0 0 28px rgba(245,166,35,0.6); }
.fab.grade-fab { border-color:var(--study-col); color:var(--study-col); box-shadow:0 0 20px rgba(0,212,255,0.2); }
.fab.grade-fab:hover { background:var(--study-col); color:#000; }
.fab-badge { position:absolute; top:-4px; right:-4px; width:17px; height:17px; border-radius:50%; background:var(--red); color:#fff; font-family:'Orbitron',sans-serif; font-size:0.5rem; display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity 0.2s; }
.fab-badge.show { opacity:1; }

/* Todo drawer */
.todo-input-row { display:flex; gap:0.5rem; padding:0.9rem 1.3rem; border-bottom:1px solid var(--border); }
.todo-input { flex:1; background:transparent; border:none; border-bottom:1px solid var(--dim); color:#ccc; font-family:'Share Tech Mono',monospace; font-size:0.82rem; padding:0.3rem 0.2rem; outline:none; transition:border-color 0.2s; }
.todo-input:focus { border-bottom-color:var(--gold); color:#fff; }
.todo-due-input { background:transparent; border:none; border-bottom:1px solid var(--dim); color:#888; font-family:'Share Tech Mono',monospace; font-size:0.72rem; padding:0.2rem; outline:none; width:100%; margin-top:0.4rem; }
.todo-filters { display:flex; gap:0.4rem; padding:0.5rem 1.3rem; border-bottom:1px solid var(--border); }
.todo-filter { font-family:'Orbitron',sans-serif; font-size:0.55rem; letter-spacing:0.1em; padding:0.2rem 0.55rem; border:1px solid var(--dim); background:transparent; color:var(--dim-text); cursor:pointer; transition:all 0.15s; }
.todo-filter:hover { border-color:var(--gold); color:var(--gold); box-shadow:none; }
.todo-filter.active { border-color:var(--gold); background:rgba(245,166,35,0.1); color:var(--gold); }
.todo-list { flex:1; overflow-y:auto; padding:0.5rem 0; scrollbar-width:thin; scrollbar-color:var(--dim) transparent; }
.todo-item { display:flex; align-items:flex-start; gap:0.7rem; padding:0.55rem 1.3rem; border-bottom:1px solid rgba(26,26,48,0.5); transition:background 0.15s; }
.todo-item:hover { background:rgba(245,166,35,0.03); }
.todo-item.done .todo-text { text-decoration:line-through; color:var(--dim-text); }
.todo-check { flex-shrink:0; width:16px; height:16px; margin-top:2px; border:1px solid var(--dim); border-radius:2px; background:transparent; cursor:pointer; position:relative; transition:all 0.2s; }
.todo-check:hover { border-color:var(--gold); }
.todo-item.done .todo-check { border-color:var(--green); background:var(--green); }
.todo-item.done .todo-check::after { content:'‚úì'; position:absolute; top:-3px; left:0; font-size:12px; color:#000; font-weight:bold; }
.todo-text { flex:1; font-size:0.8rem; color:#bbb; line-height:1.4; word-break:break-word; }
.todo-due { font-size:0.65rem; margin-top:0.15rem; }
.todo-due.overdue { color:var(--red); }
.todo-due.due-soon { color:var(--gold); }
.todo-due.due-ok { color:var(--dim-text); }
.todo-delete { flex-shrink:0; background:transparent; border:none; color:var(--dim-text); font-size:0.8rem; cursor:pointer; padding:0 0.2rem; opacity:0; transition:opacity 0.2s,color 0.2s; }
.todo-item:hover .todo-delete { opacity:1; }
.todo-delete:hover { color:var(--red); box-shadow:none; }
.todo-add-btn { background:transparent; border:1px solid var(--gold); color:var(--gold); font-family:'Orbitron',sans-serif; font-size:0.65rem; padding:0.3rem 0.7rem; cursor:pointer; transition:all 0.2s; white-space:nowrap; align-self:flex-start; }
.todo-add-btn:hover { background:var(--gold); color:#000; box-shadow:none; }
.todo-footer { padding:0.65rem 1.3rem; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.todo-count { font-size:0.65rem; color:var(--dim-text); }
.todo-clear-btn { background:transparent; border:1px solid var(--dim); color:var(--dim-text); font-family:'Orbitron',sans-serif; font-size:0.55rem; padding:0.22rem 0.6rem; cursor:pointer; transition:all 0.2s; }
.todo-clear-btn:hover { border-color:var(--red); color:var(--red); box-shadow:none; }

/* Grade drawer */
.grade-drawer-body { flex:1; overflow-y:auto; padding:0.8rem 1.3rem; display:flex; flex-direction:column; gap:1rem; scrollbar-width:thin; scrollbar-color:var(--dim) transparent; }
.grade-subject { border:1px solid var(--border); padding:0.8rem; display:flex; flex-direction:column; gap:0.5rem; }
.grade-subject-name { font-family:'Orbitron',sans-serif; font-size:0.72rem; letter-spacing:0.1em; color:var(--gold); }
.grade-entry { display:flex; align-items:center; gap:0.5rem; }
.grade-entry input[type="text"] { flex:1; background:transparent; border:none; border-bottom:1px solid var(--dim); color:#bbb; font-family:'Share Tech Mono',monospace; font-size:0.75rem; padding:0.15rem 0.2rem; outline:none; }
.grade-score-inp { width:42px; background:transparent; border:none; border-bottom:1px solid var(--dim); color:#bbb; font-family:'Orbitron',monospace; font-size:0.78rem; padding:0.15rem 0.2rem; outline:none; text-align:center; }
.grade-slash { color:var(--dim-text); font-size:0.75rem; }
.grade-avg { font-family:'Orbitron',sans-serif; font-size:0.62rem; color:var(--dim-text); display:flex; align-items:center; gap:0.4rem; margin-top:0.2rem; }
.grade-avg-num { font-size:0.78rem; }
.grade-avg-num.grade-a { color:var(--green); }
.grade-avg-num.grade-b { color:var(--gold); }
.grade-avg-num.grade-c { color:var(--break-col); }
.grade-avg-num.grade-d { color:var(--red); }
.grade-add-entry { background:transparent; border:1px dashed var(--dim); color:var(--dim-text); font-family:'Share Tech Mono',monospace; font-size:0.7rem; padding:0.25rem; cursor:pointer; transition:all 0.2s; width:100%; }
.grade-add-entry:hover { border-color:var(--gold); color:var(--gold); box-shadow:none; }
.grade-del { background:transparent; border:none; color:var(--dim-text); font-size:0.75rem; cursor:pointer; opacity:0; transition:opacity 0.2s; }
.grade-entry:hover .grade-del { opacity:1; }
.grade-del:hover { color:var(--red); box-shadow:none; }
.grade-footer { padding:0.65rem 1.3rem; border-top:1px solid var(--border); }
.add-subject-row { display:flex; gap:0.5rem; }
.add-subject-inp { flex:1; background:transparent; border:none; border-bottom:1px solid var(--dim); color:#bbb; font-family:'Share Tech Mono',monospace; font-size:0.8rem; padding:0.25rem 0.2rem; outline:none; }
.add-subject-btn { background:transparent; border:1px solid var(--study-col); color:var(--study-col); font-family:'Orbitron',sans-serif; font-size:0.62rem; padding:0.28rem 0.7rem; cursor:pointer; transition:all 0.2s; }
.add-subject-btn:hover { background:var(--study-col); color:#000; box-shadow:none; }

@media (max-width:580px) {
  .main-display { grid-template-columns:1fr; grid-template-rows:auto 1px auto; }
  .divider { width:80%; height:1px; margin:0 auto; background:linear-gradient(to right,transparent,rgba(245,166,35,0.35),transparent) !important; }
  .right-panel { align-items:center; text-align:center; padding:2rem 1.5rem; }
  .side-drawer { width:100vw; right:-100vw; }
}
</style>
</head>
<body>

<div id="loading-screen">
  <div class="logo">KRONOS</div>
  <div class="load-sub">LOADING YOUR DATA‚Ä¶</div>
</div>

<!-- ‚ïê‚ïê‚ïê SETUP ‚ïê‚ïê‚ïê -->
<div id="setup-screen">
  <div class="setup-user-bar">
    <span id="user-greeting">Hey ‚Äî</span>
    <button onclick="logout()">LOGOUT</button>
  </div>
  <h1>‚¨° KRONOS</h1>
  <div class="day-tabs">
    <button class="day-tab active" onclick="switchDay('Mon')">MON</button>
    <button class="day-tab" onclick="switchDay('Tue')">TUE</button>
    <button class="day-tab" onclick="switchDay('Wed')">WED</button>
    <button class="day-tab" onclick="switchDay('Thu')">THU</button>
    <button class="day-tab" onclick="switchDay('Fri')">FRI</button>
  </div>
  <div class="copy-row">
    <span>Copy from:</span>
    <select id="copy-from"><option value="">‚Äî select ‚Äî</option><option>Mon</option><option>Tue</option><option>Wed</option><option>Thu</option><option>Fri</option></select>
    <button onclick="copyFromDay()" style="padding:0.28rem 0.85rem;font-size:0.65rem;">COPY</button>
  </div>
  <div class="setup-table-wrap">
    <table>
      <thead><tr><th>Period #</th><th>Period Name</th><th>Start</th><th>End</th><th>Type</th><th></th></tr></thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>
  <div class="btn-row">
    <button onclick="addRow('','','','','class')">+ CLASS</button>
    <button class="break-btn" onclick="addRow('','','','','break')">‚òï BREAK</button>
    <button class="study-btn" onclick="addRow('','','','','study')">üìñ STUDY</button>
    <button class="go" onclick="saveTimetableAndLaunch()">‚ñ∂ SAVE & LAUNCH</button>
  </div>
  <span class="save-indicator" id="save-indicator">‚úì SAVED</span>
</div>

<!-- ‚ïê‚ïê‚ïê DISPLAY ‚ïê‚ïê‚ïê -->
<div id="display-screen">
  <div class="top-bar">
    <div class="top-bar-left">
      <span class="clock" id="wall-clock">00:00:00</span>
      <div class="display-day-tabs">
        <button class="display-day-tab" onclick="switchDisplayDay('Mon')">MON</button>
        <button class="display-day-tab" onclick="switchDisplayDay('Tue')">TUE</button>
        <button class="display-day-tab" onclick="switchDisplayDay('Wed')">WED</button>
        <button class="display-day-tab" onclick="switchDisplayDay('Thu')">THU</button>
        <button class="display-day-tab" onclick="switchDisplayDay('Fri')">FRI</button>
      </div>
      <span class="streak-badge" id="streak-badge"></span>
    </div>
    <div class="top-bar-right">
      <span class="user-chip" id="display-user-chip"></span>
      <button class="edit-btn" onclick="goBack()">‚Üê EDIT</button>
    </div>
  </div>
  <div class="school-day-bar-strip">
    <div class="school-day-bar-header">
      <span class="school-day-label">SCHOOL DAY PROGRESS</span>
      <span class="school-day-pct" id="school-day-pct">0%</span>
    </div>
    <div class="school-day-track"><div class="school-day-fill" id="school-day-fill" style="width:0%"></div></div>
  </div>
  <div class="main-display">
    <div class="left-panel" id="left-panel">
      <div class="study-pulse-ring"></div>
      <div class="period-label" id="period-label">PERIOD --</div>
      <div class="percent-display" id="percent-display">--<span class="percent-symbol">%</span></div>
      <div class="progress-bar-track"><div class="progress-bar-fill" id="progress-fill" style="width:0%"></div></div>
      <div class="time-label">TIME REMAINING</div>
      <div class="time-remaining" id="time-remaining">--:--</div>
    </div>
    <div class="divider" id="divider"></div>
    <div class="right-panel">
      <div>
        <div class="section-tag" id="now-tag">NOW</div>
        <div class="period-emoji" id="period-emoji"></div>
        <div class="current-class-name" id="current-name">‚Äî</div>
        <div class="current-class-time" id="current-time"></div>
      </div>
      <div>
        <div class="section-tag">UP NEXT</div>
        <div class="next-class-name" id="next-name">‚Äî</div>
        <div class="next-class-time" id="next-time"></div>
      </div>
      <div class="quote-box"><div class="quote-text" id="quote-text"></div><div class="quote-author" id="quote-author"></div></div>
    </div>
    <div class="day-status-overlay" id="day-status-overlay">
      <div class="status-big" id="status-big">ALL DONE!</div>
      <div class="status-sub" id="status-sub"></div>
      <div class="streak-display" id="streak-display"></div>
    </div>
  </div>
  <div class="history-strip">
    <span class="history-label">TODAY SO FAR</span>
    <div class="history-items" id="history-items"><span style="color:var(--dim-text);font-size:0.65rem">No completed periods yet</span></div>
  </div>
</div>

<div class="fab-group" id="fab-group" style="display:none">
  <button class="fab grade-fab" onclick="openDrawer('grade')" title="Grades">üìä<span class="fab-badge" id="grade-badge"></span></button>
  <button class="fab" onclick="openDrawer('todo')" title="To-Do">‚úì<span class="fab-badge" id="todo-badge"></span></button>
</div>

<div class="drawer-backdrop" id="drawer-backdrop" onclick="closeAllDrawers()"></div>

<!-- TODO DRAWER -->
<div class="side-drawer" id="todo-drawer">
  <div class="drawer-header"><h2>‚úì TO-DO LIST</h2><button class="drawer-close" onclick="closeAllDrawers()">‚úï</button></div>
  <div class="todo-input-row">
    <div style="flex:1;display:flex;flex-direction:column;gap:0.4rem">
      <input class="todo-input" id="todo-input" type="text" placeholder="Add a task..." maxlength="120" onkeydown="if(event.key==='Enter')addTodo()">
      <input class="todo-due-input" id="todo-due" type="date" title="Due date (optional)">
    </div>
    <button class="todo-add-btn" onclick="addTodo()">ADD</button>
  </div>
  <div class="todo-filters">
    <button class="todo-filter active" onclick="setFilter('all',this)">ALL</button>
    <button class="todo-filter" onclick="setFilter('active',this)">ACTIVE</button>
    <button class="todo-filter" onclick="setFilter('done',this)">DONE</button>
    <button class="todo-filter" onclick="setFilter('overdue',this)">OVERDUE</button>
  </div>
  <div class="todo-list" id="todo-list"></div>
  <div class="todo-footer"><span class="todo-count" id="todo-count">0 tasks</span><button class="todo-clear-btn" onclick="clearDone()">CLEAR DONE</button></div>
</div>

<!-- GRADE DRAWER -->
<div class="side-drawer" id="grade-drawer">
  <div class="drawer-header"><h2>üìä GRADE TRACKER</h2><button class="drawer-close" onclick="closeAllDrawers()">‚úï</button></div>
  <div class="grade-drawer-body" id="grade-body"></div>
  <div class="grade-footer">
    <div class="add-subject-row">
      <input class="add-subject-inp" id="add-subject-inp" type="text" placeholder="New subject..." onkeydown="if(event.key==='Enter')addSubject()">
      <button class="add-subject-btn" onclick="addSubject()">+ ADD</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL  = 'https://taoxspuawounvngmvtvv.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhb3hzcHVhd291bnZuZ212dHZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0ODg1NjcsImV4cCI6MjA4NzA2NDU2N30.U89oeo8NqhFkCYzg59NB2fG9RmiM8ApMFw0HCv6PCxU';

let session = null;
let userProfile = null;

/* ‚ïê‚ïê AUTH ‚ïê‚ïê */
function getSession() {
  try { return JSON.parse(localStorage.getItem('kronos_session')); } catch(e) { return null; }
}
function getToken() { return session?.access_token || ''; }

async function refreshIfNeeded() {
  if (!session) return false;
  // Refresh if within 5 mins of expiry
  if (session.expires_at - (Date.now() / 1000) < 300 && session.refresh_token) {
    const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=refresh_token`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_ANON },
      body: JSON.stringify({ refresh_token: session.refresh_token })
    });
    const data = await res.json();
    if (data.access_token) {
      session = data;
      localStorage.setItem('kronos_session', JSON.stringify(data));
    }
  }
  return true;
}

function logout() {
  localStorage.removeItem('kronos_session');
  localStorage.removeItem('kronos_user');
  window.location.href = '/';
}

/* ‚ïê‚ïê SUPABASE DIRECT REST ‚ïê‚ïê */
function sbHeaders() {
  return {
    'Content-Type': 'application/json',
    'apikey': SUPABASE_ANON,
    'Authorization': `Bearer ${getToken()}`
  };
}
async function sbGet(table, filter='') {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${filter}`, { headers: sbHeaders() });
  return res.json();
}
async function sbPost(table, body) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
    method: 'POST', headers: { ...sbHeaders(), 'Prefer': 'return=representation' },
    body: JSON.stringify(body)
  });
  return res.json();
}
async function sbPatch(table, filter, body) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${filter}`, {
    method: 'PATCH', headers: { ...sbHeaders(), 'Prefer': 'return=representation' },
    body: JSON.stringify(body)
  });
  return res.json();
}
async function sbDelete(table, filter) {
  await fetch(`${SUPABASE_URL}/rest/v1/${table}?${filter}`, {
    method: 'DELETE', headers: sbHeaders()
  });
}
async function sbUpsert(table, body, onConflict) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?on_conflict=${onConflict}`, {
    method: 'POST', headers: { ...sbHeaders(), 'Prefer': 'resolution=merge-duplicates,return=representation' },
    body: JSON.stringify(body)
  });
  return res.json();
}

/* ‚ïê‚ïê INIT ‚ïê‚ïê */
async function init() {
  session = getSession();
  if (!session || !session.access_token) {
    window.location.href = '/';
    return;
  }
  userProfile = JSON.parse(localStorage.getItem('kronos_user') || '{}');
  const name = userProfile.name || 'there';
  document.getElementById('user-greeting').textContent = `Hey, ${name} üëã`;
  document.getElementById('display-user-chip').textContent = name.toUpperCase();

  const userId = session.user?.id;

  // Load timetable
  try {
    const rows = await sbGet('timetables', `user_id=eq.${userId}&select=day,periods`);
    if (Array.isArray(rows)) {
      rows.forEach(row => {
        try { timetableData[row.day] = typeof row.periods === 'string' ? JSON.parse(row.periods) : row.periods; } catch(e) {}
      });
    }
  } catch(e) { console.warn('Timetable load failed', e); }

  // Load todos
  try {
    const rows = await sbGet('todos', `user_id=eq.${userId}&order=created_at.desc`);
    if (Array.isArray(rows)) todos = rows.map(t => ({ id: t.id, text: t.text, done: t.done, due: t.due }));
  } catch(e) { console.warn('Todos load failed', e); }

  // Load grades
  try {
    const rows = await sbGet('grades', `user_id=eq.${userId}`);
    if (Array.isArray(rows) && rows[0]) {
      grades = typeof rows[0].data === 'string' ? JSON.parse(rows[0].data) : (rows[0].data || {});
    }
  } catch(e) { console.warn('Grades load failed', e); }

  // Hide loading, show setup
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('setup-screen').style.display = 'flex';
  loadDayRows('Mon');
  renderTodos();
  updateStreak();
  renderStreak();
  pickQuote('class');
}

/* ‚ïê‚ïê STATE ‚ïê‚ïê */
const DAYS = ['Mon','Tue','Wed','Thu','Fri'];
let timetableData = {Mon:[],Tue:[],Wed:[],Thu:[],Fri:[]};
let activeSetupDay = 'Mon', activeDisplayDay = 'Mon', ticker = null;
const BREAK_EMOJIS = ['‚òï','üéÆ','üéµ','üçï','üò¥','üßÉ','üèÉ','üì±','üéß','üßÅ'];
const STUDY_EMOJIS = ['üìñ','üìö','‚úèÔ∏è','üß†','üí°','üìù','üî¨','üìê','üñäÔ∏è','üéØ'];
let emojiCycle = 0;
setInterval(()=>emojiCycle++, 10000);

const QUOTES = [
  {text:"This is IB, you may pick 2: Good Grades, Enough Sleep, or a Social Life.",author:"IB Quotes #1018",type:"class"},
  {text:"The day I ditched school for homework.",author:"IB Quotes #145",type:"class"},
  {text:"You know you're in IB when you procrastinate by doing 'less important' homework.",author:"IB Quotes #1668",type:"class"},
  {text:"I used to have a life. Then I started cheating on it with IB.",author:"IB Quotes #330",type:"class"},
  {text:"In IB we don't believe in miracles‚Ä¶ We rely on them!",author:"IB Quotes #3",type:"class"},
  {text:"If you think you're doing the IB, you're wrong. The IB's doing you.",author:"IB Quotes #485",type:"class"},
  {text:"Remember how they told you that real life is harder than IB? They lied.",author:"Former IB Student",type:"class"},
  {text:"Perfection is the asymptote in an IB student's life.",author:"IB Quotes #1868",type:"class"},
  {text:"A good night's sleep is 5 hours.",author:"IB Quotes #2957",type:"class"},
  {text:"Social life? What's that?",author:"IB Quotes #2957",type:"class"},
  {text:"You get nervous when you have free time.",author:"IB Quotes #2957",type:"class"},
  {text:"We nerds will rule the land, because you cannot kill what already has no life.",author:"IB Quotes #1197",type:"class"},
  {text:"'You shall not pass.' ‚Äî Gandalf, on the IB.",author:"IB Quotes #393",type:"break"},
  {text:"Seeing a well-rested IB student is like seeing a unicorn.",author:"IB Quotes #585",type:"break"},
  {text:"IB Rebel: sneaks around own house to print homework when supposed to be sleeping.",author:"IB Quotes #3939",type:"break"},
  {text:"Honors Student: Did you do anything fun for your birthday? IB Student: I got to bed before midnight. It was wonderful.",author:"IB Quotes #577",type:"break"},
  {text:"It rains and you place the umbrella over your bookbag instead of yourself.",author:"IB Quotes #2957",type:"break"},
  {text:"Isn't it funny how 50 hours of community service is a punishment in the real world, but a requirement in IB?",author:"IB Quotes #957",type:"break"},
  {text:"Are you an asymptote? Because I feel myself getting closer.",author:"IB Pickup Lines",type:"break"},
  {text:"Only in IB can you bullshit a 10-page commentary on a poem less than 10 words.",author:"IB Quotes #1698",type:"study"},
  {text:"ToK in a nutshell ‚Äî The Question: How do we know? The Answer: We don't.",author:"IB Quotes #58",type:"study"},
  {text:"The only way to pass ToK is to prove it does not exist.",author:"IB Quotes #1372",type:"study"},
  {text:"An IB grad: veteran procrastinator, immune to caffeine, professional BSer, can function on little sleep.",author:"IB Quotes #1149",type:"study"},
  {text:"SL Maths Teacher: Are we ever going to use this in real life? Also Teacher: Yes ‚Äî in the exam.",author:"IB Quotes #237",type:"study"},
  {text:"The good thing about IB: when you're up at 3am, you can call anyone ‚Äî they're up too.",author:"IB Quotes #1569",type:"study"},
  {text:"You've mastered procrastination so well that your essay finishes printing seconds before you leave.",author:"IB Quotes #2957",type:"study"},
];
let lastQuoteType = '';

function pickQuote(type) {
  const pool = QUOTES.filter(q => q.type === type);
  if (!pool.length) return;
  const q = pool[Math.floor(Math.random() * pool.length)];
  document.getElementById('quote-text').textContent = `"${q.text}"`;
  document.getElementById('quote-author').textContent = `‚Äî ${q.author}`;
  lastQuoteType = type;
}
setInterval(() => { if (lastQuoteType) pickQuote(lastQuoteType); }, 60000);

/* ‚ïê‚ïê SETUP ‚ïê‚ïê */
function todayKey() { return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date().getDay()]; }

function switchDay(day) {
  saveCurrentRows(); activeSetupDay = day;
  document.querySelectorAll('.day-tab').forEach(t => t.classList.toggle('active', t.textContent.trim() === day.toUpperCase()));
  loadDayRows(day);
}
function saveCurrentRows() {
  timetableData[activeSetupDay] = Array.from(document.querySelectorAll('#table-body tr')).map(r => {
    const inp = r.querySelectorAll('input'); const sel = r.querySelector('select');
    return { num: inp[0].value, name: inp[1].value, start: inp[2].value, end: inp[3].value, type: sel.value };
  });
}
function loadDayRows(day) {
  document.getElementById('table-body').innerHTML = '';
  const data = timetableData[day];
  if (!data.length) { addRow(); return; }
  data.forEach(d => addRow(d.num, d.name, d.start, d.end, d.type || 'class'));
}
function copyFromDay() {
  const from = document.getElementById('copy-from').value;
  if (!from || from === activeSetupDay) return;
  saveCurrentRows();
  timetableData[activeSetupDay] = timetableData[from].map(r => ({ ...r }));
  loadDayRows(activeSetupDay);
}
function addRow(num='', name='', start='', end='', type='class') {
  const tbody = document.getElementById('table-body');
  const idx = tbody.rows.length; const tr = document.createElement('tr');
  setRowClass(tr, type);
  tr.innerHTML = `
    <td><input type="number" min="1" max="30" value="${num||(type==='class'?idx+1:'')}" style="width:52px"></td>
    <td><input type="text" placeholder="${type==='break'?'e.g. Morning Break':type==='study'?'e.g. Study Period':'e.g. Computer Science HL'}" value="${name}"></td>
    <td><input type="time" value="${start}"></td>
    <td><input type="time" value="${end}"></td>
    <td><select class="type-select"><option value="class" ${type==='class'?'selected':''}>Class</option><option value="break" ${type==='break'?'selected':''}>Break</option><option value="study" ${type==='study'?'selected':''}>Study</option></select></td>
    <td><button class="danger" onclick="this.closest('tr').remove()">‚úï</button></td>`;
  tr.querySelector('select').addEventListener('change', e => setRowClass(tr, e.target.value));
  tbody.appendChild(tr);
}
function setRowClass(tr, type) {
  tr.classList.remove('is-break','is-study');
  if (type==='break') tr.classList.add('is-break');
  if (type==='study') tr.classList.add('is-study');
}
function parseTimetable(day) {
  return (timetableData[day]||[]).filter(r=>r.name&&r.start&&r.end).sort((a,b)=>a.start.localeCompare(b.start));
}

async function saveTimetableAndLaunch() {
  saveCurrentRows();
  const userId = session?.user?.id;
  if (userId) {
    try {
      await Promise.all(DAYS.map(day =>
        sbUpsert('timetables', { user_id: userId, day, periods: JSON.stringify(timetableData[day]) }, 'user_id,day')
      ));
      showSaveIndicator();
    } catch(e) { console.warn('Save failed', e); }
  }
  launchDisplay();
}

function showSaveIndicator() {
  const el = document.getElementById('save-indicator');
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}

function launchDisplay() {
  if (!DAYS.some(d => parseTimetable(d).length)) { alert('Add at least one period!'); return; }
  const today = todayKey();
  activeDisplayDay = DAYS.includes(today) ? today : 'Mon';
  document.getElementById('setup-screen').style.display = 'none';
  document.getElementById('display-screen').style.display = 'flex';
  document.getElementById('fab-group').style.display = 'flex';
  updateDisplayDayTabs(); pickQuote('class');
  tick(); ticker = setInterval(tick, 1000);
}

function goBack() {
  clearInterval(ticker);
  document.getElementById('display-screen').style.display = 'none';
  document.getElementById('fab-group').style.display = 'none';
  document.getElementById('setup-screen').style.display = 'flex';
  closeAllDrawers(); loadDayRows(activeSetupDay);
}
function switchDisplayDay(day) { activeDisplayDay = day; updateDisplayDayTabs(); tick(); }
function updateDisplayDayTabs() {
  const today = todayKey(); const todayIdx = DAYS.indexOf(today);
  document.querySelectorAll('.display-day-tab').forEach((t, i) => {
    const day = DAYS[i]; t.classList.remove('active','day-done','day-upcoming');
    const pip = t.querySelector('.day-pip'); if (pip) pip.remove();
    if (day === activeDisplayDay) t.classList.add('active');
    else if (todayIdx >= 0 && i < todayIdx) { t.classList.add('day-done'); const p=document.createElement('span');p.className='day-pip';t.appendChild(p); }
    else if (todayIdx >= 0 && i > todayIdx) t.classList.add('day-upcoming');
  });
}

/* ‚ïê‚ïê STREAK ‚ïê‚ïê */
function getStreak() { try{return JSON.parse(localStorage.getItem('ct_streak')||'{"count":0,"lastDay":""}');}catch(e){return{count:0,lastDay:''};} }
function updateStreak() {
  const today=new Date().toISOString().split('T')[0]; const s=getStreak();
  const yesterday=new Date(); yesterday.setDate(yesterday.getDate()-1);
  const yStr=yesterday.toISOString().split('T')[0];
  if(s.lastDay===today)return;
  const ns={count:(s.lastDay===yStr)?s.count+1:1,lastDay:today};
  localStorage.setItem('ct_streak',JSON.stringify(ns));
}
function renderStreak() {
  const s=getStreak();
  const badge=document.getElementById('streak-badge'); const disp=document.getElementById('streak-display');
  badge.textContent=s.count>1?`üî• ${s.count} DAY STREAK`:'';
  if(disp) disp.textContent=s.count>1?`üî• ${s.count} DAY STREAK`:'';
}

/* ‚ïê‚ïê PERIOD HISTORY ‚ïê‚ïê */
let completedPeriods=[];
function checkPeriodHistory(periods,nowM) {
  const container=document.getElementById('history-items');
  periods.forEach(p=>{
    const key=p.start+'-'+p.end;
    if(nowM>=timeToMinutes(p.end)&&!completedPeriods.find(c=>c.key===key))
      completedPeriods.push({key,name:p.name,type:p.type||'class'});
  });
  if(!completedPeriods.length){container.innerHTML='<span style="color:var(--dim-text);font-size:0.65rem">No completed periods yet</span>';return;}
  container.innerHTML=completedPeriods.map(p=>{
    const cls=p.type==='break'?'break-pill':p.type==='study'?'study-pill':'class-pill';
    const icon=p.type==='break'?'‚òï ':p.type==='study'?'üìñ ':'';
    return `<span class="history-pill ${cls}">${icon}${p.name}</span>`;
  }).join('');
}

/* ‚ïê‚ïê SCHOOL DAY BAR ‚ïê‚ïê */
function updateSchoolDayBar(periods,nowM,mode) {
  if(!periods.length)return;
  const dayStart=timeToMinutes(periods[0].start),dayEnd=timeToMinutes(periods[periods.length-1].end);
  const total=dayEnd-dayStart; if(total<=0)return;
  const elapsed=Math.max(0,Math.min(nowM-dayStart,total));
  const pct=(elapsed/total)*100;
  const fill=document.getElementById('school-day-fill');
  document.getElementById('school-day-pct').textContent=Math.floor(pct)+'%';
  fill.style.width=pct.toFixed(1)+'%';
  fill.className='school-day-fill'+(mode==='class'?' active-class':mode==='break'?' on-break':mode==='study'?' on-study':mode==='done'?' day-complete':'');
}

/* ‚ïê‚ïê DAY OVERLAY ‚ïê‚ïê */
function showDayOverlay(type,periods) {
  const ov=document.getElementById('day-status-overlay');
  const big=document.getElementById('status-big'),sub=document.getElementById('status-sub');
  if(type==='done'){
    ov.className='day-status-overlay done-overlay visible';
    big.textContent='ALL DONE!';
    sub.textContent=activeDisplayDay===todayKey()?'That\'s a wrap ‚Äî enjoy your evening! üéâ':'This day is complete ‚úì';
    renderStreak();
  } else if(type==='upcoming'){
    ov.className='day-status-overlay upcoming-overlay visible';
    big.textContent=periods.length?'NOT YET':'NO CLASSES';
    sub.textContent=periods.length?`First: ${periods[0].name}  ¬∑  ${fmtTime(periods[0].start)}`:'Nothing set for this day';
    document.getElementById('streak-display').textContent='';
  } else { ov.className='day-status-overlay'; }
}

/* ‚ïê‚ïê TIME UTILS ‚ïê‚ïê */
function nowMinutes(){const d=new Date();return d.getHours()*60+d.getMinutes()+d.getSeconds()/60;}
function timeToMinutes(t){const[h,m]=t.split(':').map(Number);return h*60+m;}
function fmtTime(t){const[h,m]=t.split(':').map(Number);return`${h%12||12}:${String(m).padStart(2,'0')} ${h>=12?'PM':'AM'}`;}
function fmtCountdown(sec){const s=Math.round(Math.abs(sec));return`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;}

/* ‚ïê‚ïê MAIN TICK ‚ïê‚ïê */
function tick(){
  document.getElementById('wall-clock').textContent=new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const periods=parseTimetable(activeDisplayDay),nowM=nowMinutes();
  const today=todayKey(),todayIdx=DAYS.indexOf(today),viewIdx=DAYS.indexOf(activeDisplayDay);
  const isPast=todayIdx>=0&&viewIdx<todayIdx,isFuture=todayIdx>=0&&viewIdx>todayIdx;
  let overlayType=null;
  if(isPast)overlayType='done';
  else if(isFuture)overlayType='upcoming';
  else if(periods.length){
    const dayStart=timeToMinutes(periods[0].start),dayEnd=timeToMinutes(periods[periods.length-1].end);
    if(nowM>=dayEnd)overlayType='done';
    else if(nowM<dayStart)overlayType='upcoming';
  }
  showDayOverlay(overlayType,periods);
  if(overlayType==='done')updateSchoolDayBar(periods,nowM,'done');
  if(overlayType){if(!isPast&&!isFuture)updateSchoolDayBar(periods,nowM,'');return;}
  if(activeDisplayDay===today)checkPeriodHistory(periods,nowM);

  let current=null,next=null;
  for(let i=0;i<periods.length;i++){
    const s=timeToMinutes(periods[i].start),e=timeToMinutes(periods[i].end);
    if(nowM>=s&&nowM<e){current={...periods[i],_idx:i};next=periods[i+1]||null;break;}
    if(s>nowM&&!current&&!next)next=periods[i];
  }
  const lp=document.getElementById('left-panel'),pd=document.getElementById('percent-display'),pf=document.getElementById('progress-fill');
  const trEl=document.getElementById('time-remaining'),divEl=document.getElementById('divider');
  const emEl=document.getElementById('period-emoji'),nameEl=document.getElementById('current-name'),nowTag=document.getElementById('now-tag');
  let dayMode='';
  if(current){
    const s=timeToMinutes(current.start),e=timeToMinutes(current.end);
    const total=(e-s)*60,elapsed=(nowM-s)*60;
    const remaining=Math.max(0,total-elapsed),pct=Math.min(100,Math.max(0,(elapsed/total)*100));
    const t=current.type||'class';
    if(t==='break'){
      dayMode='break'; if(lastQuoteType!=='break')pickQuote('break');
      lp.className='left-panel break-bg'; divEl.className='divider break-div';
      document.getElementById('period-label').textContent='BREAK';
      pd.innerHTML=`${Math.floor(pct)}<span class="percent-symbol">%</span>`; pd.className='percent-display break-display';
      pf.style.width=pct+'%'; pf.className='progress-bar-fill break-fill';
      trEl.textContent=fmtCountdown(remaining); trEl.className='time-remaining break-timer';
      emEl.textContent=BREAK_EMOJIS[emojiCycle%BREAK_EMOJIS.length];
      nameEl.textContent=current.name||'Break'; nameEl.className='current-class-name break-name'; nowTag.textContent='‚òï BREAK';
    } else if(t==='study'){
      dayMode='study'; if(lastQuoteType!=='study')pickQuote('study');
      lp.className='left-panel study-bg'; divEl.className='divider study-div';
      document.getElementById('period-label').textContent='STUDY';
      pd.innerHTML=`${Math.floor(pct)}<span class="percent-symbol">%</span>`; pd.className='percent-display study-display';
      pf.style.width=pct+'%'; pf.className='progress-bar-fill study-fill';
      trEl.textContent=fmtCountdown(remaining); trEl.className='time-remaining study-timer';
      emEl.textContent=STUDY_EMOJIS[emojiCycle%STUDY_EMOJIS.length];
      nameEl.textContent=current.name||'Study Period'; nameEl.className='current-class-name study-name'; nowTag.textContent='üìñ STUDY';
    } else {
      dayMode='class'; if(lastQuoteType!=='class')pickQuote('class');
      const nearEnd=pct>=85;
      lp.className='left-panel'; divEl.className='divider';
      document.getElementById('period-label').textContent=current.num?`PERIOD ${current.num}`:'NOW';
      pd.innerHTML=`${Math.floor(pct)}<span class="percent-symbol">%</span>`; pd.className='percent-display'+(nearEnd?' near-end':'');
      pf.style.width=pct+'%'; pf.className='progress-bar-fill'+(nearEnd?' near-end':'');
      trEl.textContent=fmtCountdown(remaining); trEl.className='time-remaining';
      emEl.textContent=''; nameEl.textContent=current.name; nameEl.className='current-class-name'; nowTag.textContent='NOW';
    }
    document.getElementById('current-time').textContent=`${fmtTime(current.start)} ‚Äì ${fmtTime(current.end)}`;
  } else {
    if(lastQuoteType!=='class')pickQuote('class');
    lp.className='left-panel'; divEl.className='divider';
    document.getElementById('period-label').textContent='FREE';
    pd.innerHTML='FREE'; pd.className='percent-display free-display';
    pf.style.width='100%'; pf.className='progress-bar-fill free-fill';
    trEl.textContent='--:--'; trEl.className='time-remaining';
    emEl.textContent=''; nameEl.textContent='‚Äî No Class Now ‚Äî'; nameEl.className='current-class-name';
    document.getElementById('current-time').textContent=''; nowTag.textContent='NOW';
  }
  if(next){
    const icon=next.type==='break'?'‚òï ':next.type==='study'?'üìñ ':'';
    document.getElementById('next-name').textContent=icon+next.name;
    document.getElementById('next-time').textContent=`${fmtTime(next.start)} ‚Äì ${fmtTime(next.end)}`;
  } else {
    document.getElementById('next-name').textContent=periods.length?'Done for today! üéâ':'No classes set';
    document.getElementById('next-time').textContent='';
  }
  updateSchoolDayBar(periods,nowM,dayMode);
}

/* ‚ïê‚ïê DRAWERS ‚ïê‚ïê */
function openDrawer(which){
  closeAllDrawers();
  document.getElementById(which+'-drawer').classList.add('open');
  document.getElementById('drawer-backdrop').classList.add('show');
  if(which==='todo')setTimeout(()=>document.getElementById('todo-input').focus(),350);
  if(which==='grade')renderGrades();
}
function closeAllDrawers(){
  document.querySelectorAll('.side-drawer').forEach(d=>d.classList.remove('open'));
  document.getElementById('drawer-backdrop').classList.remove('show');
}

/* ‚ïê‚ïê TO-DO ‚ïê‚ïê */
let todos=[], todoFilter='all';

async function addTodo(){
  const inp=document.getElementById('todo-input'); const dueInp=document.getElementById('todo-due');
  const text=inp.value.trim(); if(!text)return;
  const userId=session?.user?.id;
  try {
    const rows = await sbPost('todos', { user_id: userId, text, due: dueInp.value||null, done: false });
    if (Array.isArray(rows) && rows[0]) { todos.unshift(rows[0]); renderTodos(); }
  } catch(e) { console.warn('Add todo failed', e); }
  inp.value=''; dueInp.value=''; inp.focus();
}
async function toggleTodo(id){
  const t=todos.find(x=>x.id===id); if(!t)return;
  t.done=!t.done; renderTodos();
  try { await sbPatch('todos', `id=eq.${id}`, { done: t.done }); } catch(e) {}
}
async function deleteTodo(id){
  todos=todos.filter(x=>x.id!==id); renderTodos();
  try { await sbDelete('todos', `id=eq.${id}`); } catch(e) {}
}
async function clearDone(){
  const userId=session?.user?.id;
  todos=todos.filter(x=>!x.done); renderTodos();
  try { await sbDelete('todos', `user_id=eq.${userId}&done=eq.true`); } catch(e) {}
}
function setFilter(f,btn){
  todoFilter=f;
  document.querySelectorAll('.todo-filter').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); renderTodos();
}
function renderTodos(){
  const today=new Date().toISOString().split('T')[0];
  const tomorrow=new Date(); tomorrow.setDate(tomorrow.getDate()+1); const tomStr=tomorrow.toISOString().split('T')[0];
  const remaining=todos.filter(x=>!x.done).length;
  document.getElementById('todo-count').textContent=`${todos.length} task${todos.length!==1?'s':''}  ¬∑  ${remaining} left`;
  const badge=document.getElementById('todo-badge'); badge.textContent=remaining; badge.className='fab-badge'+(remaining>0?' show':'');
  let filtered=todos;
  if(todoFilter==='active')filtered=todos.filter(x=>!x.done);
  else if(todoFilter==='done')filtered=todos.filter(x=>x.done);
  else if(todoFilter==='overdue')filtered=todos.filter(x=>!x.done&&x.due&&x.due<today);
  const list=document.getElementById('todo-list');
  if(!filtered.length){list.innerHTML=`<div style="padding:2rem;color:var(--dim-text);font-size:0.8rem;text-align:center">${todoFilter==='overdue'?'Nothing overdue üéâ':'No tasks here.'}</div>`;return;}
  list.innerHTML=filtered.map(t=>{
    let dueHtml='';
    if(t.due){
      const isOverdue=!t.done&&t.due<today; const isSoon=!t.done&&(t.due===today||t.due===tomStr);
      const cls=isOverdue?'overdue':isSoon?'due-soon':'due-ok';
      const label=t.due===today?'Due today':t.due===tomStr?'Due tomorrow':`Due ${t.due}`;
      dueHtml=`<div class="todo-due ${cls}">${isOverdue?'‚ö† OVERDUE':'üìÖ'} ${label}</div>`;
    }
    return `<div class="todo-item${t.done?' done':''}">
      <div class="todo-check" onclick="toggleTodo(${t.id})"></div>
      <div style="flex:1"><div class="todo-text">${escHtml(t.text)}</div>${dueHtml}</div>
      <button class="todo-delete" onclick="deleteTodo(${t.id})">‚úï</button>
    </div>`;
  }).join('');
}

/* ‚ïê‚ïê GRADES ‚ïê‚ïê */
let grades={};
let gradesSaveTimer=null;
function saveGrades(){
  clearTimeout(gradesSaveTimer);
  gradesSaveTimer=setTimeout(async ()=>{
    const userId=session?.user?.id; if(!userId)return;
    try { await sbUpsert('grades', { user_id: userId, data: grades }, 'user_id'); } catch(e) {}
  }, 800);
}
function addSubject(){
  const inp=document.getElementById('add-subject-inp');
  const name=inp.value.trim(); if(!name||grades[name])return;
  grades[name]=[]; saveGrades(); renderGrades(); inp.value='';
}
function addEntry(subject){ if(!grades[subject])grades[subject]=[]; grades[subject].push({label:'',score:'',max:'100'}); saveGrades(); renderGrades(); }
function delEntry(subject,idx){ grades[subject].splice(idx,1); saveGrades(); renderGrades(); }
function delSubject(subject){ if(!confirm(`Delete ${subject}?`))return; delete grades[subject]; saveGrades(); renderGrades(); }
function updateEntry(subject,idx,field,val){ if(grades[subject])grades[subject][idx][field]=val; saveGrades(); updateAvg(subject); }
function updateAvg(subject){
  const el=document.getElementById('avg-'+subject.replace(/[^a-zA-Z0-9]/g,'_')); if(!el)return;
  const entries=(grades[subject]||[]).filter(e=>e.score!==''&&e.max!=='');
  if(!entries.length){el.textContent='‚Äî';el.className='grade-avg-num';return;}
  const pct=entries.reduce((a,e)=>a+(parseFloat(e.score)/parseFloat(e.max)*100),0)/entries.length;
  el.textContent=pct.toFixed(1)+'%';
  el.className='grade-avg-num '+(pct>=80?'grade-a':pct>=65?'grade-b':pct>=50?'grade-c':'grade-d');
}
function renderGrades(){
  const body=document.getElementById('grade-body');
  const subjects=Object.keys(grades);
  if(!subjects.length){body.innerHTML='<div style="padding:2rem;color:var(--dim-text);font-size:0.8rem;text-align:center">Add a subject below.</div>';return;}
  body.innerHTML=subjects.map(s=>{
    const sid=s.replace(/[^a-zA-Z0-9]/g,'_');
    const rows=(grades[s]||[]).map((e,i)=>`
      <div class="grade-entry">
        <input type="text" style="flex:1;background:transparent;border:none;border-bottom:1px solid var(--dim);color:#bbb;font-family:'Share Tech Mono',monospace;font-size:0.75rem;padding:0.15rem 0.2rem;outline:none;" placeholder="Assessment" value="${escHtml(e.label)}" oninput="updateEntry('${escHtml(s)}',${i},'label',this.value)">
        <div class="grade-score-wrap" style="display:flex;align-items:center;gap:0.3rem">
          <input type="number" class="grade-score-inp" placeholder="‚Äî" value="${e.score}" oninput="updateEntry('${escHtml(s)}',${i},'score',this.value)">
          <span class="grade-slash">/</span>
          <input type="number" class="grade-score-inp" value="${e.max||100}" oninput="updateEntry('${escHtml(s)}',${i},'max',this.value)">
        </div>
        <button class="grade-del" onclick="delEntry('${escHtml(s)}',${i})">‚úï</button>
      </div>`).join('');
    return `<div class="grade-subject">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="grade-subject-name">${escHtml(s)}</div>
        <button class="danger" style="opacity:0.5;font-size:0.6rem;padding:0.15rem 0.5rem" onclick="delSubject('${escHtml(s)}')">‚úï</button>
      </div>
      <div class="grade-entries">${rows}</div>
      <button class="grade-add-entry" onclick="addEntry('${escHtml(s)}')">+ Add assessment</button>
      <div class="grade-avg">AVG: <span class="grade-avg-num" id="avg-${sid}">‚Äî</span></div>
    </div>`;
  }).join('');
  subjects.forEach(s=>updateAvg(s));
}

function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

init();
</script>
</body>
</html>
